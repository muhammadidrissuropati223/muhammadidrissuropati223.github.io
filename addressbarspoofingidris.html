<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Address Autofill Form with PiP Video â€” Send IP to Webhook (with Consent)</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
    #emailOutput { font-weight: bold; color: green; margin-top: 20px; text-align: center; font-size: 18px; white-space: pre-line; }
    .form-container { max-width: 480px; margin: 20px auto; }
    label, input, button { margin: 10px 0; display: block; width: 100%; }
    input[type="text"] { padding: 8px; max-width: 100%; box-sizing: border-box; }
    button { padding: 10px; background-color: #4CAF50; color: white; border: none; cursor: pointer; font-size: 16px; }
    button:hover { background-color: #45a049; }
    .consent { font-size: 14px; }
    .note { font-size: 13px; color: #555; margin-top: 8px; }
  </style>
</head>
<body>

  <div class="form-container">
    <h2>Address autofill demo</h2>

    <label for="consent">
      <input type="checkbox" id="consent" />
      Saya setuju data (alamat sementara + user-agent) dan IP saya dikirim ke server untuk keperluan demo.
    </label>

    <label for="emailInput">Masukkan alamat (opsional)</label>
    <input
      type="text"
      id="emailInput"
      name="address"
      autocomplete="street-address"
      placeholder="Klik dan ketik alamat..."
    />

    <div class="note">
      <strong>Catatan:</strong> IP akan tercatat oleh server webhook. Data lain yang dikirim: potongan alamat (maks 200 char), user-agent, timestamp, dan path halaman.
    </div>

    <button id="pipBtn">Tampilkan video PiP</button>

    <div id="emailOutput">Address: </div>
  </div>

  <div style="max-width:640px; margin: 10px auto;">
    <video id="video" controls style="display:none; width:320px; height:240px;">
      <source src="https://github.com/frozzipies/frozzipies.github.io/raw/refs/heads/main/pip.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <script>
    // ====== CONFIG ======
    const WEBHOOK_URL = 'https://webhook.site/59ed04f6-1409-4aef-b440-8ac3c6213972';
    // ====================

    const inputEl = document.getElementById('emailInput');
    const outputEl = document.getElementById('emailOutput');
    const consentEl = document.getElementById('consent');
    const videoEl = document.getElementById('video');
    const pipBtn = document.getElementById('pipBtn');

    // Tampilkan PiP (sederhana)
    pipBtn.addEventListener('click', async () => {
      if (!videoEl) return;
      videoEl.style.display = 'block';
      try {
        if (!document.pictureInPictureEnabled) {
          console.warn('Picture-in-Picture not supported');
          return;
        }
        // di beberapa browser video harus diputar terlebih dahulu
        await videoEl.play().catch(()=>{ /* ignore play errors */ });
        await videoEl.requestPictureInPicture();
      } catch (err) {
        console.error('PiP error', err);
      }
    });

    // Update tampilan lokal
    function updateLocalOutput(value) {
      outputEl.textContent = "\n\n\n\nAddress: " + value;
    }

    // Prepare payload ringan
    function buildPayload(addressValue) {
      return {
        addressHint: (addressValue || '').slice(0, 200), // potong supaya kecil
        ts: new Date().toISOString(),
        ua: navigator.userAgent,
        page: location.pathname
      };
    }

    // Kirim menggunakan sendBeacon jika tersedia (lebih andal saat unload),
    // fallback ke fetch dengan keepalive (modern browsers)
    function sendToWebhook(payload) {
      const json = JSON.stringify(payload);

      // Blobs untuk sendBeacon
      if (navigator.sendBeacon) {
        try {
          const blob = new Blob([json], { type: 'application/json' });
          const ok = navigator.sendBeacon(WEBHOOK_URL, blob);
          if (ok) return Promise.resolve();
          // jika sendBeacon gagal (return false), fallback ke fetch
        } catch (e) {
          // lanjut ke fetch fallback
        }
      }

      // fetch fallback; keepalive agar dapat dikirim saat page unload (body kecil)
      return fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: json,
        keepalive: true,
        mode: 'cors'
      }).then(() => {}).catch(() => {});
    }

    // Handler input: hanya kirim jika user memberi consent (checkbox)
    let lastSent = 0;
    inputEl.addEventListener('input', () => {
      const val = inputEl.value || '';
      updateLocalOutput(val);

      if (!consentEl.checked) {
        // tidak mengirim tanpa persetujuan
        return;
      }

      // throttle pengiriman: mis. kirim maksimal 1 request per 2 detik
      const now = Date.now();
      if (now - lastSent < 2000) return;
      lastSent = now;

      const payload = buildPayload(val);
      // kirim (server akan melihat IP dari koneksi)
      sendToWebhook(payload);
    });

    // opsi: ketika user meninggalkan halaman, kirim sekali terakhir (jika consent)
    window.addEventListener('beforeunload', () => {
      if (!consentEl.checked) return;
      const payload = buildPayload(inputEl.value || '');
      // gunakan sendBeacon bila tersedia (synchronous)
      if (navigator.sendBeacon) {
        try {
          const blob = new Blob([JSON.stringify(payload)], { type: 'application/json' });
          navigator.sendBeacon(WEBHOOK_URL, blob);
        } catch (e) { /* ignore */ }
      } else {
        // fetch keepalive fallback (tidak selalu berhasil di semua browser)
        fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          keepalive: true,
          mode: 'cors'
        }).catch(()=>{});
      }
    });
  </script>
</body>
</html>
